{# templates/reports.html #}
{% extends "base.html" %}
{% block title %}Relatórios Estratégicos{% endblock %}
{% block content %}
<div class="container-fluid">
    <h1 class="mb-4">Relatórios de Gestão e BI</h1>

    <div class="row">
        <div class="col-md-6">
            <div class="card mb-4 shadow-sm">
                <div class="card-header bg-primary text-white">
                    <i class="fas fa-cash-register me-1"></i> Fechamento de Caixa por Operador
                </div>
                <div class="card-body">
                    <div class="row g-3 mb-3">
                        <div class="col">
                            <label class="form-label">Data Inicial:</label>
                            <input type="date" class="form-control" id="cashReportStartDate">
                        </div>
                        <div class="col">
                            <label class="form-label">Data Final:</label>
                            <input type="date" class="form-control" id="cashReportEndDate">
                        </div>
                    </div>
                    <button class="btn btn-primary w-100 mb-2" id="generateCashReportBtn">Gerar Relatório</button>
                    <button class="btn btn-outline-secondary w-100" id="printCashReportBtn" style="display: none;">
                        <i class="fas fa-print"></i> Imprimir Relatório de Caixa
                    </button>

                    <div id="cashReportResults" class="mt-4" style="display: none;">
                        <div id="printableCashArea">
                            <h5 class="text-center">Resumo de Vendas por Operador</h5>
                            <hr>
                            <div id="operatorTablesContainer"></div>
                            <div class="alert alert-info mt-3">
                                <strong>TOTAL GERAL CONSOLIDADO: R$ <span id="totalGeneralAmount">0.00</span></strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card mb-4 shadow-sm">
                <div class="card-header bg-success text-white">
                    <i class="fas fa-boxes me-1"></i> Inventário e Valor de Ativo em Estoque
                </div>
                <div class="card-body">
                    <button class="btn btn-success w-100 mb-2" id="generateStockReportBtn">Gerar Inventário</button>
                    <button class="btn btn-outline-secondary w-100" id="printStockReportBtn" style="display: none;">
                        <i class="fas fa-print"></i> Imprimir Inventário
                    </button>

                    <div id="stockReportResults" class="mt-4" style="display: none;">
                        <div id="printableStockArea">
                            <h5 class="text-center">Relatório de Ativo Circulante (Estoque)</h5>
                            <table class="table table-sm table-striped mt-3">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Produto</th>
                                        <th>Qtd</th>
                                        <th>Custo/Preço</th>
                                        <th class="text-end">Valor Total</th>
                                    </tr>
                                </thead>
                                <tbody id="stockList"></tbody>
                            </table>
                            <div class="alert alert-success mt-3 text-end">
                                <strong>Capital Total Imobilizado: R$ <span id="totalStockValue">0.00</span></strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card mb-4 shadow-sm">
                <div class="card-header bg-warning text-dark">
                    <i class="fas fa-chart-line me-1"></i> Performance de Produtos (Curva ABC Simplicada)
                </div>
                <div class="card-body">
                    <button class="btn btn-warning w-100 mb-3" id="generateTopBtn">Analisar Top 10 Produtos</button>
                    <div id="topProductsContainer" style="display:none;">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Posição</th>
                                    <th>Produto</th>
                                    <th>Qtd. Vendida</th>
                                    <th class="text-end">Receita Total</th>
                                </tr>
                            </thead>
                            <tbody id="topProductsBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts_extra %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        
        function printDiv(divId, title) {
            const content = document.getElementById(divId).innerHTML;
            const win = window.open('', '_blank');
            win.document.write(`<html><head><title>${title}</title>`);
            win.document.write('<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">');
            win.document.write('<style>body{padding:20px;} .alert{border:1px solid #000;} .card{margin-bottom:10px;}</style></head><body>');
            win.document.write(`<h2 class="text-center">${title}</h2><p class="text-center">Gerado em: ${new Date().toLocaleString()}</p>`);
            win.document.write(content);
            win.document.write('</body></html>');
            setTimeout(() => { win.print(); win.close(); }, 500);
        }

        document.getElementById('generateCashReportBtn').addEventListener('click', function() {
            const startDate = document.getElementById('cashReportStartDate').value;
            const endDate = document.getElementById('cashReportEndDate').value;
            
            fetch(`/reports/cash_flow?start_date=${startDate}&end_date=${endDate}`)
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('operatorTablesContainer');
                    container.innerHTML = '';
                    
                    for (const [operator, values] of Object.entries(data.operators)) {
                        const avgTicket = values.VendasCount > 0 ? (values.Total / values.VendasCount).toFixed(2) : "0.00";
                        const card = `
                            <div class="card border-dark mb-3">
                                <div class="card-header bg-light d-flex justify-content-between">
                                    <strong>Operador: ${operator}</strong>
                                    <span>Vendas: ${values.VendasCount}</span>
                                </div>
                                <div class="card-body p-2">
                                    <table class="table table-sm table-bordered mb-0" style="font-size: 0.9rem;">
                                        <tr><td>Dinheiro</td><td class="text-end">R$ ${values.Dinheiro.toFixed(2)}</td></tr>
                                        <tr><td>Cartão Crédito</td><td class="text-end">R$ ${values['Cartao Credito'].toFixed(2)}</td></tr>
                                        <tr><td>Cartão Débito</td><td class="text-end">R$ ${values['Cartao Debito'].toFixed(2)}</td></tr>
                                        <tr><td>Pix</td><td class="text-end">R$ ${values.Pix.toFixed(2)}</td></tr>
                                        <tr class="table-secondary"><td><strong>Total</strong></td><td class="text-end"><strong>R$ ${values.Total.toFixed(2)}</strong></td></tr>
                                        <tr class="table-info"><td><strong>Ticket Médio</strong></td><td class="text-end"><strong>R$ ${avgTicket}</strong></td></tr>
                                    </table>
                                </div>
                            </div>
                        `;
                        container.insertAdjacentHTML('beforeend', card);
                    }
                    
                    document.getElementById('totalGeneralAmount').textContent = data.total_general.toFixed(2);
                    document.getElementById('cashReportResults').style.display = 'block';
                    document.getElementById('printCashReportBtn').style.display = 'block';
                })
                .catch(err => alert('Erro ao buscar dados do caixa.'));
        });

        document.getElementById('printCashReportBtn').addEventListener('click', () => printDiv('printableCashArea', 'Relatório de Fechamento de Caixa'));

        document.getElementById('generateStockReportBtn').addEventListener('click', function() {
            fetch('/reports/stock')
                .then(response => response.json())
                .then(data => {
                    const list = document.getElementById('stockList');
                    list.innerHTML = '';
                    
                    data.products.forEach(p => {
                        list.insertAdjacentHTML('beforeend', `
                            <tr>
                                <td>${p.name}</td>
                                <td>${p.stock}</td>
                                <td>R$ ${p.price.toFixed(2)}</td>
                                <td class="text-end">R$ ${p.value.toFixed(2)}</td>
                            </tr>
                        `);
                    });
                    
                    document.getElementById('totalStockValue').textContent = data.total_value.toFixed(2);
                    document.getElementById('stockReportResults').style.display = 'block';
                    document.getElementById('printStockReportBtn').style.display = 'block';
                });
        });

        document.getElementById('printStockReportBtn').addEventListener('click', () => printDiv('printableStockArea', 'Relatório de Inventário de Estoque'));

        document.getElementById('generateTopBtn').addEventListener('click', function() {
            fetch('/reports/top_products')
                .then(response => response.json())
                .then(data => {
                    const body = document.getElementById('topProductsBody');
                    body.innerHTML = '';
                    data.forEach((p, index) => {
                        body.insertAdjacentHTML('beforeend', `
                            <tr>
                                <td>${index + 1}º</td>
                                <td>${p.name}</td>
                                <td>${p.quantity}</td>
                                <td class="text-end">R$ ${p.revenue.toFixed(2)}</td>
                            </tr>
                        `);
                    });
                    document.getElementById('topProductsContainer').style.display = 'block';
                });
        });
    });
</script>
{% endblock %}