{# templates/reports.html #}
{% extends "base.html" %}
{% block title %}Relatórios Administrativos Estratégicos{% endblock %}
{% block content %}
<div class="container-fluid">
    <h1 class="mb-4">Relatórios de Caixa, Inventário e Curva ABC</h1>

    <div class="card mb-4 shadow-sm border-primary">
        <div class="card-header bg-primary text-white">
            <i class="fas fa-filter me-1"></i> Filtros de Relatório por Operador
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-5">
                    <label class="form-label">Data Inicial:</label>
                    <input type="date" class="form-control" id="cashReportStartDate">
                </div>
                <div class="col-md-5">
                    <label class="form-label">Data Final:</label>
                    <input type="date" class="form-control" id="cashReportEndDate">
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button class="btn btn-primary w-100" id="generateCashReportBtn">Gerar Relatórios</button>
                </div>
            </div>
        </div>
    </div>

    <div id="cashReportResults" style="display: none;">
        <div id="operatorReportsContainer"></div>
        <div class="alert alert-dark mt-4 text-end">
            <h4>FATURAMENTO TOTAL CONSOLIDADO: R$ <span id="totalGeneralAmount">0.00</span></h4>
        </div>
    </div>

    <hr class="my-5">

    <div class="row mb-5">
        <div class="col-md-12">
            <div class="card shadow-sm border-warning">
                <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-chart-pie me-1"></i> Análise de Curva ABC (Lucratividade por Produto)</span>
                    <button class="btn btn-sm btn-outline-dark no-print" id="printABCReportBtn" style="display: none;">
                        <i class="fas fa-print"></i> Imprimir Curva ABC
                    </button>
                </div>
                <div class="card-body">
                    <p class="text-muted small">A Classificação ABC identifica os produtos que geram maior impacto financeiro (Classe A = 80% da receita).</p>
                    <button class="btn btn-warning mb-3" id="generateABCReportBtn">Gerar Análise ABC</button>
                    
                    <div id="abcReportResults" style="display: none;">
                        <div id="printableABCArea">
                            <table class="table table-sm table-hover border-dark">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Categoria</th>
                                        <th>Produto</th>
                                        <th class="text-end">Receita Acumulada</th>
                                        <th class="text-center">% Acumulada</th>
                                    </tr>
                                </thead>
                                <tbody id="abcList"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            <div class="card mb-4 shadow-sm border-success">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-boxes me-1"></i> Inventário de Estoque (Ativos)</span>
                    <button class="btn btn-sm btn-light no-print" id="printStockReportBtn" style="display: none;">
                        <i class="fas fa-print"></i> Imprimir Inventário
                    </button>
                </div>
                <div class="card-body">
                    <button class="btn btn-success mb-3" id="generateStockReportBtn">Gerar Inventário Atualizado</button>
                    
                    <div id="stockReportResults" style="display: none;">
                        <div id="printableStockArea">
                            <table class="table table-sm table-striped table-bordered border-dark">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Produto</th>
                                        <th class="text-center">Qtd. em Stock</th>
                                        <th class="text-center">Preço Unitário</th>
                                        <th class="text-end">Valor Total em Stock</th>
                                    </tr>
                                </thead>
                                <tbody id="stockList"></tbody>
                            </table>
                            <div class="alert alert-success mt-2 text-end">
                                <h5>Valor Total de Mercadoria: R$ <span id="totalStockValue">0.00</span></h5>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts_extra %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        
        // Função Geral para Impressão Separada
        function printContent(divId, title) {
            const content = document.getElementById(divId).innerHTML;
            const timestamp = new Date().toLocaleString();
            const win = window.open('', '_blank');
            win.document.write('<html><head><title>' + title + '</title>');
            win.document.write('<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">');
            win.document.write('<style>body{padding:40px;} .no-print{display:none;} table{width:100%;} th, td{border:1px solid #333 !important; padding:8px;} .header-print{border-bottom:3px solid #000; margin-bottom:20px; text-align:center;} .cat-A{background-color: #d4edda !important;} .cat-B{background-color: #fff3cd !important;} .cat-C{background-color: #f8d7da !important;}</style></head><body>');
            win.document.write('<div class="header-print"><h1>' + title.toUpperCase() + '</h1><p>Data de Emissão: ' + timestamp + '</p></div>');
            win.document.write(content);
            win.document.write('</body></html>');
            setTimeout(() => { win.print(); win.close(); }, 700);
        }

        // --- RELATÓRIOS DE CAIXA ---
        window.printOperatorReport = function(divId, operatorName) {
            printContent(divId, 'Fechamento de Caixa - ' + operatorName);
        }

        document.getElementById('generateCashReportBtn').addEventListener('click', function() {
            const startDate = document.getElementById('cashReportStartDate').value;
            const endDate = document.getElementById('cashReportEndDate').value;
            
            fetch(`/reports/cash_flow?start_date=${startDate}&end_date=${endDate}`)
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('operatorReportsContainer');
                    container.innerHTML = '';
                    
                    for (const [operator, values] of Object.entries(data.operators)) {
                        const safeOpName = operator.replace(/\s+/g, '-');
                        let detalhesHtml = '';
                        values.detalhes.forEach(det => {
                            detalhesHtml += `<tr><td>${det.data} ${det.hora}</td><td>${det.produto}</td><td>${det.quantidade}</td><td>${det.metodo}</td><td class="text-end">R$ ${det.valor.toFixed(2)}</td></tr>`;
                        });

                        const operatorBlock = `
                            <div class="card border-dark mb-5 shadow">
                                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">Operador: <strong>${operator}</strong></h5>
                                    <button class="btn btn-sm btn-outline-dark no-print" onclick="printOperatorReport('print-area-${safeOpName}', '${operator}')">
                                        <i class="fas fa-print"></i> Imprimir Caixa de ${operator}
                                    </button>
                                </div>
                                <div class="card-body" id="print-area-${safeOpName}">
                                    <div class="row">
                                        <div class="col-md-5">
                                            <table class="table table-sm table-bordered border-dark">
                                                <tr class="table-info"><th colspan="2" class="text-center">Resumo de Recebimentos</th></tr>
                                                <tr><td>Dinheiro</td><td class="text-end">R$ ${values.Dinheiro.toFixed(2)}</td></tr>
                                                <tr><td>Cartão Crédito</td><td class="text-end">R$ ${values['Cartao Credito'].toFixed(2)}</td></tr>
                                                <tr><td>Cartão Débito</td><td class="text-end">R$ ${values['Cartao Debito'].toFixed(2)}</td></tr>
                                                <tr><td>Pix</td><td class="text-end">R$ ${values.Pix.toFixed(2)}</td></tr>
                                                <tr class="table-dark text-white"><td><strong>SUBTOTAL</strong></td><td class="text-end"><strong>R$ ${values.Total.toFixed(2)}</strong></td></tr>
                                            </table>
                                        </div>
                                        <div class="col-md-7">
                                            <table class="table table-sm table-hover border">
                                                <thead class="table-secondary"><tr><th>Hora</th><th>Produto</th><th>Qtd</th><th>Meio</th><th class="text-end">Valor</th></tr></thead>
                                                <tbody>${detalhesHtml}</tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>`;
                        container.insertAdjacentHTML('beforeend', operatorBlock);
                    }
                    document.getElementById('totalGeneralAmount').textContent = data.total_general.toFixed(2);
                    document.getElementById('cashReportResults').style.display = 'block';
                });
        });

        // --- RELATÓRIO DE CURVA ABC (NOVO) ---
        document.getElementById('generateABCReportBtn').addEventListener('click', function() {
            fetch('/reports/abc_curve')
                .then(response => response.json())
                .then(data => {
                    const list = document.getElementById('abcList');
                    list.innerHTML = '';
                    data.forEach(p => {
                        const rowClass = p.category === 'A' ? 'table-success' : (p.category === 'B' ? 'table-warning' : 'table-danger');
                        list.insertAdjacentHTML('beforeend', `
                            <tr class="${rowClass}">
                                <td class="text-center fw-bold">${p.category}</td>
                                <td>${p.name}</td>
                                <td class="text-end">R$ ${p.revenue.toFixed(2)}</td>
                                <td class="text-center">${p.cumulative_percentage.toFixed(2)}%</td>
                            </tr>
                        `);
                    });
                    document.getElementById('abcReportResults').style.display = 'block';
                    document.getElementById('printABCReportBtn').style.display = 'block';
                });
        });

        document.getElementById('printABCReportBtn').addEventListener('click', function() {
            printContent('printableABCArea', 'Relatório de Curva ABC de Produtos');
        });

        // --- RELATÓRIO DE ESTOQUE ---
        document.getElementById('generateStockReportBtn').addEventListener('click', function() {
            fetch('/reports/stock')
                .then(response => response.json())
                .then(data => {
                    const list = document.getElementById('stockList');
                    list.innerHTML = '';
                    data.products.forEach(p => {
                        list.insertAdjacentHTML('beforeend', `
                            <tr>
                                <td>${p.name}</td>
                                <td class="text-center">${p.stock}</td>
                                <td class="text-center">R$ ${p.price.toFixed(2)}</td>
                                <td class="text-end">R$ ${p.value.toFixed(2)}</td>
                            </tr>
                        `);
                    });
                    document.getElementById('totalStockValue').textContent = data.total_value.toFixed(2);
                    document.getElementById('stockReportResults').style.display = 'block';
                    document.getElementById('printStockReportBtn').style.display = 'block';
                });
        });

        document.getElementById('printStockReportBtn').addEventListener('click', function() {
            printContent('printableStockArea', 'Relatório de Inventário de Estoque');
        });
    });
</script>
{% endblock %}