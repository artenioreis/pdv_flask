{% extends "base.html" %}

{% block title %}Importar Produtos{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="mt-4">Importar Produtos</h1>
    <ol class="breadcrumb mb-4">
        <li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}">Dashboard</a></li>
        <li class="breadcrumb-item"><a href="{{ url_for('main.products') }}">Produtos</a></li>
        <li class="breadcrumb-item active">Importar Produtos</li>
    </ol>
    <div class="card mb-4">
        <div class="card-header">
            <i class="fas fa-file-import me-1"></i>
            Importar Produtos via Arquivo Excel/CSV
        </div>
        <div class="card-body">
            <form method="POST" enctype="multipart/form-data" action="{{ url_for('main.import_products') }}">
                {{ form.hidden_tag() }}
                <div class="mb-3">
                    <label for="file" class="form-label">Selecione um arquivo (.xlsx, .xls, .csv)</label>
                    <input type="file" class="form-control" id="file" name="file" accept=".xlsx, .xls, .csv" required>
                </div>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-upload me-1"></i> Carregar Arquivo
                </button>
            </form>
        </div>
    </div>

    <div class="card mb-4 mt-4">
        <div class="card-header">
            <i class="fas fa-table me-1"></i>
            Pré-visualização e Importação da Tabela
        </div>
        <div class="card-body">
            <p>Se você já tem os dados em uma tabela abaixo, pode importá-los diretamente.</p>
            <form id="importTableForm" method="POST" action="{{ url_for('main.import_products') }}">
                <input type="hidden" name="products_json" id="productsJsonInput">
                <div class="table-responsive">
                    <table class="table table-bordered" id="importProductsTable" width="100%" cellspacing="0">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Código de Barras</th>
                                <th>Preço</th>
                                <th>Estoque</th>
                                <th>Alerta Retorno (dias)</th> {# NOVA COLUNA NO HEADER #}
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Linhas serão adicionadas aqui via JavaScript -->
                        </tbody>
                    </table>
                </div>
                <button type="submit" class="btn btn-success mt-3" id="importTableBtn" disabled>
                    <i class="fas fa-save me-1"></i> Importar Produtos da Tabela
                </button>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts_extra %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const fileInput = document.getElementById('file');
        const importProductsTableBody = document.querySelector('#importProductsTable tbody');
        const importTableBtn = document.getElementById('importTableBtn');
        const productsJsonInput = document.getElementById('productsJsonInput');

        let importedProductsData = []; // Para armazenar os dados da tabela

        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) {
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                // Assume a primeira linha como cabeçalho
                const headers = json[0];
                const rows = json.slice(1);

                importProductsTableBody.innerHTML = ''; // Limpa a tabela
                importedProductsData = []; // Limpa os dados anteriores

                rows.forEach((row, index) => {
                    // Mapeia os dados da linha para um objeto com base nos cabeçalhos
                    let product = {};
                    headers.forEach((header, i) => {
                        const key = header.toLowerCase().replace(/\s/g, '_'); // Normaliza o nome da coluna
                        product[key] = row[i];
                    });

                    // Adiciona valores padrão se não existirem
                    product.name = product.name || '';
                    product.barcode = product.barcode || '';
                    product.price = parseFloat(product.price) || 0;
                    product.stock = parseInt(product.stock) || 0;
                    // NOVO CAMPO: return_alert_days
                    product.return_alert_days = parseInt(product.return_alert_days) || null; // Pode ser nulo

                    importedProductsData.push(product);

                    const newRow = importProductsTableBody.insertRow();
                    newRow.innerHTML = `
                        <td><input type="text" class="form-control" value="${product.name}" data-field="name"></td>
                        <td><input type="text" class="form-control" value="${product.barcode}" data-field="barcode"></td>
                        <td><input type="number" step="0.01" class="form-control" value="${product.price.toFixed(2)}" data-field="price"></td>
                        <td><input type="number" class="form-control" value="${product.stock}" data-field="stock"></td>
                        <td><input type="number" class="form-control" value="${product.return_alert_days !== null ? product.return_alert_days : ''}" data-field="return_alert_days"></td> {# NOVO CAMPO NO INPUT #}
                        <td><button type="button" class="btn btn-danger btn-sm remove-row"><i class="fas fa-trash-alt"></i></button></td>
                    `;
                });

                updateImportButtonState();
            };
            reader.readAsArrayBuffer(file);
        });

        // Event listener para remover linha
        importProductsTableBody.addEventListener('click', function(e) {
            if (e.target.classList.contains('remove-row') || e.target.closest('.remove-row')) {
                const row = e.target.closest('tr');
                const index = Array.from(importProductsTableBody.children).indexOf(row);
                if (index > -1) {
                    importedProductsData.splice(index, 1); // Remove do array de dados
                    row.remove();
                    updateImportButtonState();
                }
            }
        });

        // Event listener para atualizar dados quando inputs são alterados
        importProductsTableBody.addEventListener('change', function(e) {
            const input = e.target;
            if (input.tagName === 'INPUT' && input.dataset.field) {
                const row = input.closest('tr');
                const index = Array.from(importProductsTableBody.children).indexOf(row);
                if (index > -1) {
                    const field = input.dataset.field;
                    let value = input.value;

                    // Converte para o tipo correto
                    if (field === 'price') {
                        value = parseFloat(value) || 0;
                    } else if (field === 'stock' || field === 'return_alert_days') { // Inclui return_alert_days
                        value = value === '' ? null : parseInt(value) || 0;
                    }
                    importedProductsData[index][field] = value;
                }
            }
        });

        // Habilita/desabilita o botão de importação da tabela
        function updateImportButtonState() {
            if (importedProductsData.length > 0) {
                importTableBtn.disabled = false;
            } else {
                importTableBtn.disabled = true;
            }
        }

        // Ao submeter o formulário da tabela, preenche o campo hidden com os dados JSON
        document.getElementById('importTableForm').addEventListener('submit', function(e) {
            // Antes de enviar, garantir que importedProductsData está atualizado com os valores atuais dos inputs
            const rows = importProductsTableBody.querySelectorAll('tr');
            importedProductsData = []; // Limpa e reconstrói
            rows.forEach(row => {
                const inputs = row.querySelectorAll('input[data-field]');
                let product = {};
                inputs.forEach(input => {
                    const field = input.dataset.field;
                    let value = input.value;
                    if (field === 'price') {
                        value = parseFloat(value) || 0;
                    } else if (field === 'stock' || field === 'return_alert_days') {
                        value = value === '' ? null : parseInt(value) || 0;
                    }
                    product[field] = value;
                });
                importedProductsData.push(product);
            });

            productsJsonInput.value = JSON.stringify(importedProductsData);
        });

        updateImportButtonState(); // Estado inicial do botão
    });
</script>
{% endblock %}
